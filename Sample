<!-- START: Company Editor (paste this before </body>) -->
<!-- Adds "Edit Companies" UI inside existing Settings modal and save to localStorage -->
<div id="companyEditorModal" class="modal-bg" style="display:none;align-items:center;justify-content:center;z-index:12000">
  <div class="modal" style="max-width:720px;overflow:auto;max-height:80vh">
    <h3 style="color:var(--neon)">Edit Solar Companies</h3>
    <div id="companyEditorList" style="margin-top:12px"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn" id="cancelEditCompanies">Cancel</button>
      <button class="btn primary" id="saveEditCompanies">Save Companies</button>
    </div>
    <div style="margin-top:10px;color:#9fb1c7;font-size:13px">Tip: change values and press Save — this updates the live site for this browser.</div>
  </div>
</div>

<script>
(function(){
  // Ensure renderCompanies() and companies[] exist (they do in main file)
  if(!window.companies) window.companies = [];

  // Create "Edit Companies" button inside Settings modal if not already present
  function addEditCompaniesButton(){
    const settingsModal = document.getElementById('settingsModal');
    if(!settingsModal) return;
    // avoid duplicate
    if(document.getElementById('editCompaniesBtn')) return;

    const btn = document.createElement('button');
    btn.id = 'editCompaniesBtn';
    btn.className = 'btn';
    btn.style.marginLeft = '8px';
    btn.textContent = 'Edit Companies';
    // place the button at top right of settings modal
    const panel = settingsModal.querySelector('.modal');
    if(panel){
      panel.insertBefore(btn, panel.querySelector('.modal') || panel.firstChild);
    } else {
      // fallback: append to body top
      document.body.appendChild(btn);
    }
    btn.addEventListener('click', openCompanyEditor);
  }

  // Build editor UI
  function openCompanyEditor(){
    const modal = document.getElementById('companyEditorModal');
    const list = document.getElementById('companyEditorList');
    list.innerHTML = '';
    // load from localStorage override if exists, else from window.companies
    const saved = JSON.parse(localStorage.getItem('jc_companies') || 'null');
    const data = saved || window.companies || [];
    // ensure at least one entry
    if(!data || data.length===0){
      // copy default companies if none
      if(window.companies && window.companies.length) data.push(...JSON.parse(JSON.stringify(window.companies)));
    }
    // create row for each company
    data.forEach((c, idx) => {
      const wrapper = document.createElement('div');
      wrapper.style.border = '1px solid rgba(255,255,255,0.04)';
      wrapper.style.padding = '10px';
      wrapper.style.borderRadius = '8px';
      wrapper.style.marginBottom = '8px';
      wrapper.innerHTML = `
        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
          <strong style="color:var(--neon)">${c.name || 'Company'}</strong>
          <button class="btn" data-remove-index="${idx}" style="background:transparent">Remove</button>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <div><label style="font-size:13px;color:#9fb1c7">Name</label><input data-field="name" value="${escapeHtml(c.name||'')}" style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:var(--neon)"></div>
          <div><label style="font-size:13px;color:#9fb1c7">Price (e.g. ₹ 170,000)</label><input data-field="price" value="${escapeHtml(c.price||'')}" style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:var(--neon)"></div>
          <div><label style="font-size:13px;color:#9fb1c7">kW (comma separated)</label><input data-field="kw" value="${escapeHtml((c.kw||[]).join(', '))}" style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:var(--neon)"></div>
          <div><label style="font-size:13px;color:#9fb1c7">Panels (format: 330W:10,360W:9)</label><input data-field="panels" value="${escapeHtml(panelsToString(c.panels||{}))}" style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:var(--neon)"></div>
        </div>
      `;
      list.appendChild(wrapper);
    });

    // add "Add new company" button
    const addBtn = document.createElement('button');
    addBtn.className = 'btn';
    addBtn.textContent = 'Add Company';
    addBtn.style.marginTop = '6px';
    addBtn.addEventListener('click', ()=> {
      data.push({id:'new'+Date.now(),name:'New Company',kw:['3.00 kW'],panels:{'330W':10,'360W':9},price:'₹ 0'});
      openCompanyEditor(); // reopen to refresh
    });
    list.appendChild(addBtn);

    // attach remove handlers (delegation)
    list.querySelectorAll('button[data-remove-index]').forEach(b=>{
      b.addEventListener('click', (ev)=>{
        const i = Number(ev.currentTarget.getAttribute('data-remove-index'));
        if(!isNaN(i) && confirm('Remove this company?')) {
          data.splice(i,1);
          // save temporarily to localStorage view then refresh
          localStorage.setItem('jc_companies_temp', JSON.stringify(data));
          openCompanyEditor();
        }
      });
    });

    // show modal
    modal.style.display = 'flex';

    // Save action wired below (global)
    // store temp data on modal element for later save
    modal.dataset.tmp = JSON.stringify(data);
  }

  // helper: convert panels object to string "330W:10,360W:9"
  function panelsToString(p){
    try{
      return Object.entries(p).map(pair=>pair[0]+':'+pair[1]).join(',');
    }catch(e){ return '';}
  }

  // parse panels string back to object
  function parsePanels(str){
    const o = {};
    str.split(',').map(s=>s.trim()).forEach(part=>{
      if(!part) return;
      const [k,v] = part.split(':').map(x=>x && x.trim());
      if(k && v) o[k]= Number(v) || v;
    });
    return o;
  }

  // escape html for input values
  function escapeHtml(s){
    return String(s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  // save handler
  document.getElementById('saveEditCompanies').addEventListener('click', function(){
    const list = document.getElementById('companyEditorList');
    const items = Array.from(list.querySelectorAll('div')).filter(d=> d.querySelector('[data-field]'));
    const newData = items.map(div=>{
      const name = div.querySelector('[data-field="name"]').value.trim();
      const price = div.querySelector('[data-field="price"]').value.trim();
      const kw = div.querySelector('[data-field="kw"]').value.split(',').map(s=>s.trim()).filter(Boolean);
      const panelsStr = div.querySelector('[data-field="panels"]').value.trim();
      const panels = parsePanels(panelsStr);
      return { id: (name||'company').toLowerCase().replace(/\s+/g,'_') + '_' + Math.floor(Math.random()*9999), name, kw, panels, price };
    });
    // save to localStorage (jc_companies) and re-render
    localStorage.setItem('jc_companies', JSON.stringify(newData));
    // update global companies variable so renderCompanies uses it
    window.companies = newData;
    if(typeof renderCompanies === 'function') renderCompanies();
    alert('Companies saved locally.');
    document.getElementById('companyEditorModal').style.display = 'none';
    // clean temp
    localStorage.removeItem('jc_companies_temp');
  });

  // cancel
  document.getElementById('cancelEditCompanies').addEventListener('click', function(){
    document.getElementById('companyEditorModal').style.display = 'none';
    localStorage.removeItem('jc_companies_temp');
  });

  // open editor when settings UI created
  // wait until DOM ready and settings modal exists
  document.addEventListener('DOMContentLoaded', function(){
    // try to add button a few times (in case settings modal loads later)
    addEditCompaniesButton();
    // also observe settings modal for insertion later
    const obsTarget = document.body;
    const obs = new MutationObserver(()=> addEditCompaniesButton());
    obs.observe(obsTarget, {childList:true, subtree:true});
  });

  // also allow loading saved companies on page init
  (function loadSavedCompanies(){
    const saved = JSON.parse(localStorage.getItem('jc_companies') || 'null');
    if(saved && Array.isArray(saved) && saved.length){
      window.companies = saved;
      if(typeof renderCompanies === 'function') renderCompanies();
    }
  })();

})();
</script>
<!-- END: Company Editor -->
